<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Web Music Player By Sujal Gupta</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
    :root{
        --bg1:#050507; --bg2:#141414; --accent:#00eaff;
    }
    html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;font-family:Inter,system-ui,Arial;}
    .wrap{max-width:980px;margin:28px auto;padding:22px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;color:var(--accent);text-shadow:0 0 18px rgba(0,234,255,0.12)}
    .controls{display:flex;gap:12px;align-items:center}
    select{background:rgba(255,255,255,0.04);color:#fff;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#001;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .player-wrap{display:flex;gap:20px;margin-top:18px;align-items:flex-start}
    .left{flex:1;min-width:240px}
    audio{width:100%;border-radius:8px;filter:drop-shadow(0 6px 16px rgba(0,0,0,0.6))}
    #visual{width:100%;height:160px;border-radius:12px;background:linear-gradient(180deg,rgba(0,234,255,0.02),transparent);margin-top:12px;padding:10px;display:flex;align-items:center;justify-content:center}
    .bars{display:flex;gap:6px;align-items:end;height:100%;width:100%;padding:0 6px;box-sizing:border-box}
    .bar{flex:1;max-width:18px;background:linear-gradient(180deg,var(--accent),#00bcd4);border-radius:6px;transform-origin:bottom center;height:8px;transition:height 0.06s linear}
    .right{width:420px;min-width:260px}
    #lyrics-box{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;height:340px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .line{opacity:0.22;padding:6px 6px;border-radius:6px;font-size:18px;transition:all 0.22s}
    .line.active{background:rgba(0,234,255,0.06);opacity:1;color:var(--accent);font-weight:700;transform:scale(1.02)}
    footer{margin-top:18px;color:rgba(255,255,255,0.35);font-size:13px;text-align:center}
    @media (max-width:860px){
        .player-wrap{flex-direction:column}
        .right{width:100%}
    }
</style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>Web Music Player By Sujal Gupta</h1>
        <div class="controls">
            <select id="playlist"></select>
            <button id="prev" class="secondary">Prev</button>
            <button id="play">Play</button>
            <button id="next" class="secondary">Next</button>
        </div>
    </header>

    <div class="player-wrap">
        <div class="left">
            <audio id="audio" controls crossorigin="anonymous"></audio>

            <div id="visual" aria-hidden="true">
                <div class="bars" id="bars"></div>
            </div>
        </div>

        <div class="right">
            <div id="lyrics-box"><div id="lyrics"></div></div>
        </div>
    </div>

    <footer>Multi-song playlist · Real-time audio analyser visualizer · Lyrics sync</footer>
</div>

<script>
/* -------------------------
   Playlist + Visualizer Fixes
   ------------------------- */

const playlistEl = document.getElementById('playlist');
const audio = document.getElementById('audio');
const barsContainer = document.getElementById('bars');
const lyricsBox = document.getElementById('lyrics');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');

let songs = [];
let current = 0;
let currentLyrics = [];
let linesEls = [];

let audioCtx = null, analyser = null, sourceNode = null, freqData = null, rafId = null;

const NUM_BARS = 32;

/* ------------------
   Create Visual Bars
   ------------------ */
function createBars(n){
    barsContainer.innerHTML = '';
    for(let i=0;i<n;i++){
        const b = document.createElement('div');
        b.className='bar';
        barsContainer.appendChild(b);
    }
}

/* ------------------------
   Load Playlist
   ------------------------ */
async function loadPlaylist(){
    const res = await fetch('/songs');
    songs = await res.json();
    playlistEl.innerHTML = '';

    songs.forEach(s=>{
        const o = document.createElement('option');
        o.value = s.id;
        o.innerText = s.title;
        playlistEl.appendChild(o);
    });

    if(songs.length) loadSongById(songs[0].id);
}

/* ------------------------
   Load a Song
   ------------------------ */
async function loadSongById(id){
    cancelViz();

    const res = await fetch(`/song/${id}`);
    if(!res.ok) return alert("Cannot load song");

    const data = await res.json();
    current = data.id;
    audio.src = "/static/" + data.filename;
    currentLyrics = data.lyrics || [];
    playlistEl.value = current;

    renderLyrics(currentLyrics);
}

/* ------------------------
   Show Lyrics
   ------------------------ */
function renderLyrics(lyrics){
    lyricsBox.innerHTML = "";
    linesEls = [];

    lyrics.forEach((item,i)=>{
        const div = document.createElement("div");
        div.className = "line";
        div.id = "line-"+i;
        div.innerText = item[1];
        lyricsBox.appendChild(div);
        linesEls.push({el:div,time:item[0]});
    });
}

/* ------------------------
   Sync Lyrics
   ------------------------ */
audio.ontimeupdate = () => {
    const t = audio.currentTime;

    for(let i=0;i<linesEls.length;i++){
        const start = linesEls[i].time;
        const next = (i+1<linesEls.length) ? linesEls[i+1].time : 99999;

        const active = (t >= start && t < next);
        linesEls[i].el.classList.toggle("active", active);

    if(active){
        linesEls[i].el.scrollIntoView({behavior:"smooth",block:"center"});
    }}
};

/* ------------------------
   FIX: Autoplay + Mute Issue
   Start AudioContext ONLY on user click
   ------------------------ */
function startAudioContext(){
    if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(audioCtx.state === "suspended"){
        audioCtx.resume();
    }
}

/* ------------------------
   Visualizer Setup
   ------------------------ */
function initViz(){
    startAudioContext();

    if(sourceNode) sourceNode.disconnect();

    sourceNode = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    analyser.smoothingTimeConstant = 0.8;

    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);

    const bufferLength = analyser.frequencyBinCount;
    freqData = new Uint8Array(bufferLength);

    animateViz();
}

/* ------------------------
   Draw Bars
   ------------------------ */
function animateViz(){
    rafId = requestAnimationFrame(animateViz);

    analyser.getByteFrequencyData(freqData);

    const bars = document.querySelectorAll('.bar');
    const binsPerBar = Math.floor(freqData.length / NUM_BARS);

    for(let i=0;i<NUM_BARS;i++){
        let sum = 0;

        for(let j=i*binsPerBar; j<(i+1)*binsPerBar; j++){
            sum += freqData[j];
        }

        const avg = sum / binsPerBar;
        const h = 6 + (avg/255)*140;

        bars[i].style.height = h + "px";
        bars[i].style.opacity = 0.4 + (avg/255)*0.7;
    }
}

/* ------------------------
   Stop Visualizer
   ------------------------ */
function cancelViz(){
    if(rafId) cancelAnimationFrame(rafId);

    try{ if(sourceNode) sourceNode.disconnect(); }catch(e){}
    try{ if(analyser) analyser.disconnect(); }catch(e){}

    analyser = null;
}

/* ------------------------
   BUTTON EVENTS
   ------------------------ */
playBtn.addEventListener("click", ()=>{
    startAudioContext();

    if(audio.paused){
        audio.play().catch(()=>{});
        playBtn.innerText = "Pause";
        initViz();
    } else {
        audio.pause();
        playBtn.innerText = "Play";
    }
});

playlistEl.addEventListener("change", ()=>{
    const id = parseInt(playlistEl.value);
    loadSongById(id);
});

prevBtn.addEventListener("click", ()=>{
    const index = songs.findIndex(s=>s.id===current);
    const prevIndex = (index - 1 + songs.length) % songs.length;
    loadSongById(songs[prevIndex].id);
});

nextBtn.addEventListener("click", ()=>{
    const index = songs.findIndex(s=>s.id===current);
    const nextIndex = (index + 1) % songs.length;
    loadSongById(songs[nextIndex].id);
});

/* ------------------------
   INITIALIZE
   ------------------------ */
window.addEventListener("load", ()=>{
    createBars(NUM_BARS);
    loadPlaylist();
});
</script>
</body>
</html>

