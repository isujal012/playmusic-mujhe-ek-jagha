<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Mujhe Ek Jagha — Pro Player</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
    :root{
        --bg1:#050507; --bg2:#141414; --accent:#00eaff;
    }
    html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;font-family:Inter,system-ui,Arial;}
    .wrap{max-width:980px;margin:28px auto;padding:22px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;color:var(--accent);text-shadow:0 0 18px rgba(0,234,255,0.12)}
    .controls{display:flex;gap:12px;align-items:center}
    select{background:rgba(255,255,255,0.04);color:#fff;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#001;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
    .player-wrap{display:flex;gap:20px;margin-top:18px;align-items:flex-start}
    .left{flex:1;min-width:240px}
    audio{width:100%;border-radius:8px;filter:drop-shadow(0 6px 16px rgba(0,0,0,0.6))}
    #visual{width:100%;height:160px;border-radius:12px;background:linear-gradient(180deg,rgba(0,234,255,0.02),transparent);margin-top:12px;padding:10px;display:flex;align-items:center;justify-content:center}
    .bars{display:flex;gap:6px;align-items:end;height:100%;width:100%;padding:0 6px;box-sizing:border-box}
    .bar{flex:1;max-width:18px;background:linear-gradient(180deg,var(--accent),#00bcd4);border-radius:6px;transform-origin:bottom center;height:8px;transition:height 0.06s linear}
    .right{width:420px;min-width:260px}
    #lyrics-box{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;height:340px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .line{opacity:0.22;padding:6px 6px;border-radius:6px;font-size:18px;transition:all 0.22s}
    .line.active{background:rgba(0,234,255,0.06);opacity:1;color:var(--accent);font-weight:700;transform:scale(1.02)}
    footer{margin-top:18px;color:rgba(255,255,255,0.35);font-size:13px;text-align:center}
    @media (max-width:860px){
        .player-wrap{flex-direction:column}
        .right{width:100%}
    }
</style>
</head>
<body>
<div class="wrap">
    <header>
        <h1>Mujhe Ek Jagha — Pro Player</h1>
        <div class="controls">
            <select id="playlist"></select>
            <button id="prev" class="secondary">Prev</button>
            <button id="play">Play</button>
            <button id="next" class="secondary">Next</button>
        </div>
    </header>

    <div class="player-wrap">
        <div class="left">
            <audio id="audio" controls crossorigin="anonymous"></audio>

            <div id="visual" aria-hidden="true">
                <div class="bars" id="bars"></div>
            </div>
        </div>

        <div class="right">
            <div id="lyrics-box"><div id="lyrics"></div></div>
        </div>
    </div>

    <footer>Multi-song playlist · Real-time audio analyser visualizer · Lyrics sync</footer>
</div>

<script>
/* -------------------------
   Client: playlist + visualizer
   ------------------------- */

const playlistEl = document.getElementById('playlist');
const audio = document.getElementById('audio');
const barsContainer = document.getElementById('bars');
const lyricsBox = document.getElementById('lyrics');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');

let songs = [];        // list from /songs
let current = 0;      // current song id
let currentLyrics = []; // [[time, text], ...]
let linesEls = [];

// Visualizer state
let audioCtx, analyser, sourceNode, freqData, rafId;
const NUM_BARS = 32; // choose number of bars for visualizer

// Create bars
function createBars(n){
    barsContainer.innerHTML = '';
    for(let i=0;i<n;i++){
        const b = document.createElement('div');
        b.className='bar';
        barsContainer.appendChild(b);
    }
}

// Fetch playlist from server
async function loadPlaylist(){
    const res = await fetch('/songs');
    songs = await res.json();
    // populate select
    playlistEl.innerHTML = '';
    songs.forEach(s => {
        const o = document.createElement('option');
        o.value = s.id;
        o.innerText = s.title;
        playlistEl.appendChild(o);
    });
    // auto-select first
    if(songs.length) loadSongById(songs[0].id);
}

// Load an individual song's metadata (lyrics + file)
async function loadSongById(id){
    cancelViz();
    const res = await fetch(`/song/${id}`);
    if(!res.ok) return alert('Failed to load song');
    const data = await res.json();
    current = data.id;
    playlistEl.value = current;
    audio.src = '/static/' + data.filename;
    currentLyrics = data.lyrics || [];
    renderLyrics(currentLyrics);
    audio.load();
    attemptStartAudioAndViz();
}

// Render lyrics in right panel
function renderLyrics(lyrics){
    lyricsBox.innerHTML = '';
    linesEls = [];
    lyrics.forEach((item,i)=>{
        const div = document.createElement('div');
        div.className='line';
        div.id = 'line-'+i;
        div.innerText = item[1];
        lyricsBox.appendChild(div);
        linesEls.push({el:div,time:item[0]});
    });
}

// Sync highlighting on timeupdate
audio.ontimeupdate = () => {
    const t = audio.currentTime;
    for(let i=0;i<linesEls.length;i++){
        const start = linesEls[i].time;
        const next = (i+1 < linesEls.length) ? linesEls[i+1].time : 99999;
        linesEls[i].el.classList.toggle('active', t >= start && t < next);
        if(t >= start && t < next){
            // scroll into view smoothly but only sometimes to avoid jitter
            if(typeof linesEls[i].el.scrollIntoView === 'function'){
                linesEls[i].el.scrollIntoView({behavior:'smooth',block:'center'});
            }
        }
    }
};

// Controls
playlistEl.addEventListener('change', (e)=> loadSongById(parseInt(e.target.value)));
playBtn.addEventListener('click', ()=>{
    if(audio.paused){ audio.play().catch(()=>{}); playBtn.innerText='Pause'; }
    else { audio.pause(); playBtn.innerText='Play'; }
});
prevBtn.addEventListener('click', ()=>{
    const idx = songs.findIndex(s=>s.id===current);
    const prevIdx = (idx - 1 + songs.length) % songs.length;
    loadSongById(songs[prevIdx].id);
});
nextBtn.addEventListener('click', ()=>{
    const idx = songs.findIndex(s=>s.id===current);
    const nextIdx = (idx + 1) % songs.length;
    loadSongById(songs[nextIdx].id);
});

// Attempt start audio & visualizer (handles autoplay restrictions)
async function attemptStartAudioAndViz(){
    try{
        await audio.play();
        playBtn.innerText = 'Pause';
    }catch(e){
        playBtn.innerText = 'Play';
    }
    initViz();
}

// Visualizer init
function initViz(){
    if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if(sourceNode) sourceNode.disconnect();
    sourceNode = audioCtx.createMediaElementSource(audio);

    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048; // resolution
    analyser.smoothingTimeConstant = 0.8;

    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);

    const bufferLength = analyser.frequencyBinCount;
    freqData = new Uint8Array(bufferLength);

    createBars(NUM_BARS);
    animateViz();
}

// Animation loop for visualizer using frequency data
function animateViz(){
    rafId = requestAnimationFrame(animateViz);
    analyser.getByteFrequencyData(freqData);

    // Compute overall volume for beat detection
    let sum = 0;
    for(let i=0;i<freqData.length;i++){ sum += freqData[i]; }
    const avg = sum / freqData.length; // 0-255

    // Map frequency bins into our NUM_BARS bars
    const binsPerBar = Math.floor(freqData.length / NUM_BARS);
    const bars = document.querySelectorAll('.bar');
    for(let b=0;b<NUM_BARS;b++){
        let start = b * binsPerBar;
        let end = start + binsPerBar;
        let s = 0;
        for(let j=start;j<end && j<freqData.length;j++) s += freqData[j];
        let v = s / binsPerBar; // average for this bar 0-255
        // Scale to px height (min 6, max 140)
        const minH = 6, maxH = 140;
        const h = minH + (v/255) * (maxH - minH);
        bars[b].style.height = h + 'px';
        // brightness effect using opacity
        bars[b].style.opacity = 0.35 + (v/255)*0.85;
    }

    // Optional – add reactive glow to page based on avg amplitude
    const glow = Math.min(0.9, Math.max(0, (avg/255)));
    document.documentElement.style.setProperty('--glow', glow);
}

// Stop visualizer (when switching songs to avoid doubling)
function cancelViz(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = null;
    // disconnect nodes safely
    try{ if(sourceNode) sourceNode.disconnect(); }catch(e){}
    try{ if(analyser) analyser.disconnect(); }catch(e){}
    analyser = null;
}

// Initialize on load
window.addEventListener('load', ()=>{
    createBars(NUM_BARS);
    loadPlaylist();
});
</script>
</body>
</html>
